<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Radio Pilot</title>
<style>
 body{margin:0;background:#666;font-family:system-ui;display:flex;flex-direction:column;align-items:center;padding-top:40px;color:white}
 .radio-box{background:#111;border:6px solid #cfcfcf;border-radius:12px;padding:20px;display:flex;align-items:center;gap:20px}
 .freq-block{color:white;font-size:52px;font-weight:700;font-family:monospace;display:flex;align-items:center}
 .label{font-size:26px;font-style:italic;margin-right:8px;color:#ddd}
 #swap{margin:20px auto;background:#ddd;border-radius:50%;width:64px;height:64px;display:flex;align-items:center;justify-content:center;font-size:32px;color:#3a5ec0;cursor:pointer}
 #ptt{position:absolute;left:40px;top:180px;background:red;color:white;font-size:22px;font-weight:700;border-radius:50%;width:80px;height:80px;display:flex;align-items:center;justify-content:center;cursor:pointer}
 #freq-list{margin-top:40px;background:#111;border:6px solid #cfcfcf;border-radius:12px;padding:20px;width:360px}
 #freq-list h2{text-align:center;margin:0 0 20px 0;font-style:italic}
 .freq-item{display:flex;justify-content:space-between;font-size:22px;padding:10px 0;border-bottom:2px solid #777;cursor:pointer}
 .freq-item span:first-child{color:#7bd0ff;font-weight:700;font-style:italic}
 .freq-item span:last-child{color:#00ff6a;font-weight:700;font-family:monospace}
</style>
</head>
<body>
<div id="ptt">PTT</div>
<div class="radio-box">
  <div class="freq-block"><span class="label">ACT</span><span id="activeFreq">123.456</span></div>
  <div class="freq-block"><span class="label">STBY</span><span id="standbyFreq">123.000</span></div>
</div>
<div id="swap">⇄</div>
<div id="freq-list"><h2>FREQUENCIES</h2><div id="freqContainer"></div></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBPq6Wfxzq02MfK69BFxHm9_FUjDGTmAcw",
  authDomain: "kykychat-24c7f.firebaseapp.com",
  databaseURL: "https://kykychat-24c7f-default-rtdb.firebaseio.com",
  projectId: "kykychat-24c7f",
  storageBucket: "kykychat-24c7f.firebasestorage.app",
  messagingSenderId: "342562811927",
  appId: "1:342562811927:web:0fed1e1f511c4fddcfec52"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let callsign = prompt("Votre indicatif ?");
let clientId = 'p_'+Math.random().toString(36).substr(2,9);
let activeFreq = 123.456;
let standbyFreq = 123.000;
let position = {lat:null, lon:null};
let heading = null;

// --- POSITION + HEADING TRACKING ---
if(navigator.geolocation){
  navigator.geolocation.watchPosition(pos=>{
    position.lat = pos.coords.latitude;
    position.lon = pos.coords.longitude;
    updatePilotData();
  });
}

window.addEventListener('deviceorientation', e=>{
  heading = e.alpha;
  updatePilotData();
});

function updatePilotData(){
  if(!position.lat) return;
  db.ref('pilots/'+clientId).set({callsign, activeFreq, position, heading});
}

// --- UPDATE UI ---
function renderFreqList(all){
  const box = document.getElementById('freqContainer');
  box.innerHTML="";
  all.forEach(f=>{
    const d = document.createElement('div');
    d.className='freq-item';
    d.innerHTML = `<span>${f.name}</span><span>${f.frequency.toFixed(2)}</span>`;
    d.onclick=()=>{
      standbyFreq = f.frequency;
      document.getElementById('standbyFreq').textContent = standbyFreq.toFixed(3);
    };
    box.appendChild(d);
  });
}

// --- LOAD NEAR FREQUENCIES ---
setInterval(async ()=>{
  if(position.lat===null) return;
  const snap = await db.ref('frequencies').get();
  const all = snap.val()||{};
  const nearby=[];
  for(const name in all){
    const f = all[name];
    const d = distanceNm(position.lat,position.lon,f.lat,f.lon);
    if(d <= f.range) nearby.push({name,frequency:f.frequency});
  }
  renderFreqList(nearby);
},2000);

function distanceNm(lat1,lon1,lat2,lon2){
  const R = 6371e3;
  const φ1=lat1*Math.PI/180, φ2=lat2*Math.PI/180;
  const dφ=(lat2-lat1)*Math.PI/180;
  const dλ=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(dλ/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const meters=R*c;
  return meters/1852;
}

// --- SWAP ---
document.getElementById('swap').onclick=()=>{
  const t=activeFreq;
  activeFreq=standbyFreq;
  standbyFreq=t;
  document.getElementById('activeFreq').textContent=activeFreq.toFixed(3);
  document.getElementById('standbyFreq').textContent=standbyFreq.toFixed(3);
  updatePilotData();
};
</script>
</body>
</html>
