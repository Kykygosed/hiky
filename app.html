<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ATC Map</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #1c1c1c;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .sidebar {
      position: fixed;
      top: 0;
      right: -300px;
      width: 300px;
      height: 100%;
      background: #121212;
      color: white;
      box-shadow: -2px 0 5px rgba(0,0,0,0.5);
      transition: right 0.3s;
      padding: 20px;
      overflow-y: auto;
    }
    .sidebar.active {
      right: 0;
    }
    .close-btn {
      background: #333;
      border: none;
      color: white;
      padding: 5px 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
    <div id="map"></div>
   <div class="sidebar" id="sidebar">
      <button class="close-btn" onclick="closeSidebar()">Fermer</button>
    <h2 id="towerName"></h2>
    <p>Fréquence : <span id="towerFreq"></span></p>
    <p>ATIS : <span id="towerAtis"></span></p>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAamXzsUBdA4KWdbpfEk1JtP1L5ENLh1Pc",
      authDomain: "plen-95d55.firebaseapp.com",
      databaseURL: "https://plen-95d55-default-rtdb.firebaseio.com",
      projectId: "plen-95d55",
      storageBucket: "plen-95d55.firebasestorage.app",
      messagingSenderId: "147249259769",
      appId: "1:147249259769:web:ee8e5952a96f244f776e28",
      measurementId: "G-ZDLRGQR5NC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getDatabase(app);

    // Auth anonyme + init controller = false si premier login
    signInAnonymously(auth);
    onAuthStateChanged(auth, user => {
      if (user) {
        const uid = user.uid;
        const accountRef = ref(db, "accounts/" + uid);
        get(accountRef).then(snap => {
          if (!snap.exists()) {
            set(accountRef, { controller: false });
          }
        });
      }
    });

    // Initialiser Leaflet
    const map = L.map('map').setView([48.8566, 2.3522], 6); // Paris
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    const sidebar = document.getElementById('sidebar');
    const towerNameEl = document.getElementById('towerName');
    const towerFreqEl = document.getElementById('towerFreq');
    const towerAtisEl = document.getElementById('towerAtis');

    function closeSidebar() {
      sidebar.classList.remove('active');
    }
    window.closeSidebar = closeSidebar;

    // Récupérer les tours depuis Realtime DB
    const towersRef = ref(db, "towers");
    onValue(towersRef, snapshot => {
      const towers = snapshot.val();
      if (!towers) return;
      Object.entries(towers).forEach(([id, tower]) => {
        addTower(tower);
      });
    });

    function addTower(tower) {
      const marker = L.marker([tower.lat, tower.lng]).addTo(map);

      const circle = L.circle([tower.lat, tower.lng], {
        radius: 22224, // 12 NM ≈ 22.224 m * 1000
        color: '#4da6ff',
        fillColor: '#4da6ff',
        fillOpacity: 0.2
      }).addTo(map);

      marker.on('click', () => {
        towerNameEl.textContent = tower.name;
        towerFreqEl.textContent = tower.freq;
        towerAtisEl.textContent = tower.atis || "(Aucun ATIS)";
        sidebar.classList.add('active');
      });
    }
  </script>
</body>
</html>
